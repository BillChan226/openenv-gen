"""
API Router for {{ entity.name }}

Auto-generated by EnvGenerator Multi-Agent System
"""

from typing import List
from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy.orm import Session

from ..database import get_db
from ..models import {{ entity.name }}
from ..schemas import (
    {{ entity.name }}Create,
    {{ entity.name }}Update,
    {{ entity.name }}Response,
)
from ..auth import get_current_user


router = APIRouter(
    prefix="/{{ entity.table_name }}",
    tags=["{{ entity.name }}"],
)


@router.get("/", response_model=List[{{ entity.name }}Response])
def list_{{ entity.name | lower }}s(
    skip: int = 0,
    limit: int = 100,
    db: Session = Depends(get_db),
    current_user = Depends(get_current_user),
):
    """List all {{ entity.name | lower }}s"""
    items = db.query({{ entity.name }}).offset(skip).limit(limit).all()
    return items


@router.post("/", response_model={{ entity.name }}Response, status_code=status.HTTP_201_CREATED)
def create_{{ entity.name | lower }}(
    data: {{ entity.name }}Create,
    db: Session = Depends(get_db),
    current_user = Depends(get_current_user),
):
    """Create a new {{ entity.name | lower }}"""
    item = {{ entity.name }}(**data.model_dump())
    {% if entity.has_user_id %}
    item.user_id = current_user.id
    {% endif %}
    db.add(item)
    db.commit()
    db.refresh(item)
    return item


@router.get("/{{ '{' }}{{ entity.name | lower }}_id{{ '}' }}", response_model={{ entity.name }}Response)
def get_{{ entity.name | lower }}(
    {{ entity.name | lower }}_id: {{ entity.id_type | default('int') }},
    db: Session = Depends(get_db),
    current_user = Depends(get_current_user),
):
    """Get a {{ entity.name | lower }} by ID"""
    item = db.query({{ entity.name }}).filter({{ entity.name }}.id == {{ entity.name | lower }}_id).first()
    if not item:
        raise HTTPException(status_code=404, detail="{{ entity.name }} not found")
    return item


@router.put("/{{ '{' }}{{ entity.name | lower }}_id{{ '}' }}", response_model={{ entity.name }}Response)
def update_{{ entity.name | lower }}(
    {{ entity.name | lower }}_id: {{ entity.id_type | default('int') }},
    data: {{ entity.name }}Update,
    db: Session = Depends(get_db),
    current_user = Depends(get_current_user),
):
    """Update a {{ entity.name | lower }}"""
    item = db.query({{ entity.name }}).filter({{ entity.name }}.id == {{ entity.name | lower }}_id).first()
    if not item:
        raise HTTPException(status_code=404, detail="{{ entity.name }} not found")
    
    update_data = data.model_dump(exclude_unset=True)
    for key, value in update_data.items():
        setattr(item, key, value)
    
    db.commit()
    db.refresh(item)
    return item


@router.delete("/{{ '{' }}{{ entity.name | lower }}_id{{ '}' }}", status_code=status.HTTP_204_NO_CONTENT)
def delete_{{ entity.name | lower }}(
    {{ entity.name | lower }}_id: {{ entity.id_type | default('int') }},
    db: Session = Depends(get_db),
    current_user = Depends(get_current_user),
):
    """Delete a {{ entity.name | lower }}"""
    item = db.query({{ entity.name }}).filter({{ entity.name }}.id == {{ entity.name | lower }}_id).first()
    if not item:
        raise HTTPException(status_code=404, detail="{{ entity.name }} not found")
    
    db.delete(item)
    db.commit()

