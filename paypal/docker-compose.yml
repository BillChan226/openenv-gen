version: "3.8"
services:
  paypal-pg:
    image: postgres:14
    environment:
      POSTGRES_DB: paypal_sandbox
      POSTGRES_USER: sandbox
      POSTGRES_PASSWORD: sandbox
    volumes:
      - ./init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sandbox -d paypal_sandbox"]
      interval: 5s
      timeout: 5s
      retries: 20
    restart: unless-stopped
  paypal-api:
    image: python:3.12-slim
    depends_on:
      paypal-pg:
        condition: service_healthy
    working_dir: /app
    environment:
      PAYPAL_PG_HOST: paypal-pg
      PAYPAL_PG_PORT: "5432"
      PAYPAL_PG_DB: paypal_sandbox
      PAYPAL_PG_USER: sandbox
      PAYPAL_PG_PASSWORD: sandbox
    volumes:
      - ./api:/app:ro
      - ./init_examples:/init_examples:ro
    command: >
      sh -c "pip install --no-cache-dir 'psycopg[binary]>=3.1' fastapi 'uvicorn[standard]' &&
             uvicorn main:app --host 0.0.0.0 --port 9051"
    healthcheck:
      test: ["CMD-SHELL", "python - <<'PY'\nimport urllib.request,sys\ntry:\n  urllib.request.urlopen('http://127.0.0.1:9051/health', timeout=2)\n  sys.exit(0)\nexcept Exception:\n  sys.exit(1)\nPY\n"]
      interval: 3s
      timeout: 3s
      retries: 40
    ports:
      - "${PAYPAL_API_PORT:-8035}:9051"
    restart: unless-stopped

  paypal-ui:
    build:
      context: ./paypal_ui
      dockerfile: Dockerfile
    depends_on:
      - paypal-api
    ports:
      - "${PAYPAL_UI_PORT:-8029}:80"


